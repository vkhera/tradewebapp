[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/var/run/supervisord.pid

; ── PostgreSQL 16 ──────────────────────────────────────────────────────────
[program:postgres]
command=/usr/lib/postgresql/16/bin/postgres
    -D /var/lib/postgresql/16/main
    -c config_file=/etc/postgresql/16/main/postgresql.conf
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres.log
startsecs=5
stopwaitsecs=30

; ── Redis 7 ────────────────────────────────────────────────────────────────
[program:redis]
command=/usr/bin/redis-server --daemonize no --loglevel notice
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis.log
startsecs=3

; ── Spring Boot backend ────────────────────────────────────────────────────
; Delayed 30 s via wrapper so postgres/redis are ready before it connects
[program:backend]
command=/bin/bash -c "sleep 30 && exec java ${JAVA_OPTS:-} -jar /app/backend.jar"
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/backend.log
stderr_logfile=/var/log/supervisor/backend.log
startsecs=60
stopwaitsecs=30

; ── Nginx (Angular + reverse-proxy) ────────────────────────────────────────
; Delayed 90 s so the backend is up before nginx begins accepting traffic
[program:nginx]
command=/bin/bash -c "sleep 90 && exec nginx -g 'daemon off;'"
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx.log
startsecs=5
