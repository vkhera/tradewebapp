# ──────────────────────────────────────────────────────────────────────────────
# Promtail configuration – ships JSON log lines from the application to Loki
#
# The app writes structured JSON to  logs/stock-brokerage.json
# (generated by logback-spring.xml via LogstashEncoder).
# This file is mounted into the Promtail container at /app/logs/ via docker-compose.
# ──────────────────────────────────────────────────────────────────────────────
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/promtail-positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:

  # ── Stock Brokerage JSON log ───────────────────────────────────────────────
  - job_name: stock-brokerage
    static_configs:
      - targets:
          - localhost
        labels:
          job:   stock-brokerage
          app:   stock-brokerage
          __path__: /app/logs/stock-brokerage.json   # JSON log file from logback

    pipeline_stages:

      # Parse the JSON line written by LogstashEncoder
      - json:
          expressions:
            level:      level
            logger:     logger
            traceId:    traceId
            spanId:     spanId
            service:    service
            message:    message
            timestamp:  timestamp

      # Promote parsed fields to Loki stream labels (low-cardinality only!)
      - labels:
          level:
          service:

      # Store traceId/spanId as structured metadata (used by Grafana for trace→log correlation)
      - structured_metadata:
          traceId:
          spanId:

      # Re-use the application timestamp instead of Promtail's ingest time
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.999Z"
            - "2006-01-02T15:04:05Z"

      # NOTE: No output stage → the original JSON line is stored in Loki.
      # This allows Grafana to regex-extract traceId from the raw JSON for
      # click-through trace correlation with Tempo.
      # To display only the human-readable message, use Grafana's "JSON" log format option.
