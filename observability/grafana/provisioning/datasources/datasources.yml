apiVersion: 1

datasources:

  # ── Prometheus – metrics ───────────────────────────────────────────────────
  - name:      Prometheus
    type:      prometheus
    uid:       prometheus
    url:       http://prometheus:9090
    isDefault: true
    access:    proxy
    editable:  true
    jsonData:
      httpMethod:             POST
      prometheusType:         Prometheus
      exemplarTraceIdDestinations:
        - name:          traceId
          datasourceUid: tempo

  # ── Loki – logs ───────────────────────────────────────────────────────────
  - name:    Loki
    type:    loki
    uid:     loki
    url:     http://loki:3100
    access:  proxy
    editable: true
    jsonData:
      maxLines: 1000
      derivedFields:
        # Extract traceId from the JSON log line and create a link to Tempo
        - name:            TraceID
          matcherRegex:    '"traceId"\s*:\s*"([a-f0-9]+)"'
          url:             "$${__value.raw}"
          datasourceUid:   tempo

  # ── Tempo – distributed traces ────────────────────────────────────────────
  - name:    Tempo
    type:    tempo
    uid:     tempo
    url:     http://tempo:3200
    access:  proxy
    editable: true
    jsonData:
      tracesToLogsV2:
        datasourceUid:   loki
        spanStartTimeShift: "-1m"
        spanEndTimeShift:   "1m"
        filterByTraceID: true
        filterBySpanID:  false
        customQuery:     false
        tags:
          - key:   service
            value: stock-brokerage
      tracesToMetrics:
        datasourceUid:  prometheus
        spanStartTimeShift: "-1m"
        spanEndTimeShift:   "1m"
        tags:
          - key: service.name
            alias: service
      serviceMap:
        datasourceUid: prometheus
      nodeGraph:
        enabled: true
      lokiSearch:
        datasourceUid: loki
